version: '3.8'

# QuietMatch Local Development Infrastructure
# This compose file sets up all infrastructure dependencies for local development

services:
  # ============================================================================
  # DATABASE: PostgreSQL 16 with pgvector extension
  # ============================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: quietmatch-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: QuietMatch_Dev_2025!
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - quietmatch-network

  # ============================================================================
  # MESSAGE BROKER: RabbitMQ with Management UI
  # ============================================================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: quietmatch-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - quietmatch-network

  # ============================================================================
  # CACHE: Redis 7 for distributed caching and SignalR backplane
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: quietmatch-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - quietmatch-network

  # ============================================================================
  # LOGGING: Seq for structured logs (local development)
  # ============================================================================
  seq:
    image: datalust/seq:2024
    container_name: quietmatch-seq
    restart: unless-stopped
    ports:
      - "5341:80"   # Web UI
      - "5342:5341" # Ingestion
    environment:
      ACCEPT_EULA: "Y"
    volumes:
      - seq_data:/data
    networks:
      - quietmatch-network

  # ============================================================================
  # MICROSERVICES (Uncomment as you implement them)
  # ============================================================================

  # identity-service:
  #   build:
  #     context: .
  #     dockerfile: src/Services/Identity/Dockerfile
  #   container_name: quietmatch-identity
  #   restart: unless-stopped
  #   ports:
  #     - "5001:8080"
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ASPNETCORE_URLS=http://+:8080
  #     - ConnectionStrings__IdentityDb=Host=postgres;Port=5432;Database=identity_db;Username=admin;Password=QuietMatch_Dev_2025!
  #     - Redis__ConnectionString=redis:6379
  #     - MessageBroker__Host=rabbitmq
  #     - MessageBroker__Port=5672
  #     - MessageBroker__Username=guest
  #     - MessageBroker__Password=guest
  #     - Jwt__Issuer=https://quietmatch.local
  #     - Jwt__Audience=https://api.quietmatch.local
  #     - Jwt__SecretKey=ThisIsASecretKeyForLocalDevelopmentOnly_ChangeInProduction_32BytesMinimum!
  #     - Jwt__AccessTokenExpiryMinutes=15
  #     - Jwt__RefreshTokenExpiryDays=7
  #     - Google__ClientId=${GOOGLE_CLIENT_ID}
  #     - Google__ClientSecret=${GOOGLE_CLIENT_SECRET}
  #     - Serilog__SeqUrl=http://seq:5341
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - quietmatch-network

  profile-service:
    build:
      context: .
      dockerfile: src/Services/Profile/Dockerfile
    container_name: quietmatch-profile
    restart: unless-stopped
    ports:
      - "5002:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__ProfileDb=Host=postgres;Port=5432;Database=profile_db;Username=admin;Password=QuietMatch_Dev_2025!
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
      - Jwt__Issuer=DatingApp.IdentityService
      - Jwt__Audience=DatingApp.ProfileService
      - Jwt__Secret=ThisIsASecretKeyForLocalDevelopmentOnly_ChangeInProduction_32BytesMinimum!
      - Encryption__Key=dGVzdGtleXRlc3RrZXl0ZXN0a2V5dGVzdGtleTE=
      - Seq__Url=http://seq:80
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - quietmatch-network

  # matching-service:
  #   build:
  #     context: .
  #     dockerfile: src/Services/Matching/Dockerfile
  #   container_name: quietmatch-matching
  #   restart: unless-stopped
  #   ports:
  #     - "5003:8080"
  #     - "5103:8081" # gRPC
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ASPNETCORE_URLS=http://+:8080
  #     - ASPNETCORE_GRPC_PORT=8081
  #     - ConnectionStrings__MatchingDb=Host=postgres;Port=5432;Database=matching_db;Username=admin;Password=QuietMatch_Dev_2025!
  #     - Redis__ConnectionString=redis:6379
  #     - MessageBroker__Host=rabbitmq
  #     - MessageBroker__Port=5672
  #     - MessageBroker__Username=guest
  #     - MessageBroker__Password=guest
  #     - Jwt__Issuer=https://quietmatch.local
  #     - Jwt__Audience=https://api.quietmatch.local
  #     - Jwt__SecretKey=ThisIsASecretKeyForLocalDevelopmentOnly_ChangeInProduction_32BytesMinimum!
  #     - Serilog__SeqUrl=http://seq:5341
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - quietmatch-network

  # scheduling-service:
  #   build:
  #     context: .
  #     dockerfile: src/Services/Scheduling/Dockerfile
  #   container_name: quietmatch-scheduling
  #   restart: unless-stopped
  #   ports:
  #     - "5004:8080"
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ASPNETCORE_URLS=http://+:8080
  #     - ConnectionStrings__SchedulingDb=Host=postgres;Port=5432;Database=scheduling_db;Username=admin;Password=QuietMatch_Dev_2025!
  #     - Redis__ConnectionString=redis:6379
  #     - MessageBroker__Host=rabbitmq
  #     - MessageBroker__Port=5672
  #     - MessageBroker__Username=guest
  #     - MessageBroker__Password=guest
  #     - Jwt__Issuer=https://quietmatch.local
  #     - Jwt__Audience=https://api.quietmatch.local
  #     - Jwt__SecretKey=ThisIsASecretKeyForLocalDevelopmentOnly_ChangeInProduction_32BytesMinimum!
  #     - Serilog__SeqUrl=http://seq:5341
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - quietmatch-network

  # notification-service:
  #   build:
  #     context: .
  #     dockerfile: src/Services/Notification/Dockerfile
  #   container_name: quietmatch-notification
  #   restart: unless-stopped
  #   ports:
  #     - "5005:8080"
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ASPNETCORE_URLS=http://+:8080
  #     - ConnectionStrings__NotificationDb=Host=postgres;Port=5432;Database=notification_db;Username=admin;Password=QuietMatch_Dev_2025!
  #     - MessageBroker__Host=rabbitmq
  #     - MessageBroker__Port=5672
  #     - MessageBroker__Username=guest
  #     - MessageBroker__Password=guest
  #     - Serilog__SeqUrl=http://seq:5341
  #     - Email__Provider=SendGrid
  #     - Email__SendGridApiKey=${SENDGRID_API_KEY}
  #     - Email__FromAddress=noreply@quietmatch.com
  #     - Email__FromName=QuietMatch
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #   networks:
  #     - quietmatch-network

  # graphql-gateway:
  #   build:
  #     context: .
  #     dockerfile: src/Gateway/GraphQL/Dockerfile
  #   container_name: quietmatch-graphql
  #   restart: unless-stopped
  #   ports:
  #     - "5000:8080"
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Development
  #     - ASPNETCORE_URLS=http://+:8080
  #     - Jwt__Issuer=https://quietmatch.local
  #     - Jwt__Audience=https://api.quietmatch.local
  #     - Jwt__SecretKey=ThisIsASecretKeyForLocalDevelopmentOnly_ChangeInProduction_32BytesMinimum!
  #     - Services__Identity=http://identity-service:8080
  #     - Services__Profile=http://profile-service:8080
  #     - Services__Matching=http://matching-service:8080
  #     - Services__Scheduling=http://scheduling-service:8080
  #     - Redis__ConnectionString=redis:6379
  #     - Serilog__SeqUrl=http://seq:5341
  #   depends_on:
  #     - redis
  #   networks:
  #     - quietmatch-network

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  quietmatch-network:
    driver: bridge
    name: quietmatch-network

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres_data:
    name: quietmatch-postgres-data
  rabbitmq_data:
    name: quietmatch-rabbitmq-data
  redis_data:
    name: quietmatch-redis-data
  seq_data:
    name: quietmatch-seq-data
